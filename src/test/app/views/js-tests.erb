<link href="/qunit/qunit.css" rel="stylesheet" type="text/css" />
<script src="/qunit/qunit.js"></script>

<script>$(document).ready(function(){


PandaUploader.alert = function(msg) {
  PandaUploader.latest_alert = msg;
}

test("Detection of features", function() {
  var support = PandaUploader.supportAjaxUpload();
  if (jQuery.browser.webkit || jQuery.browser.mozilla) {
    ok(support, 'Detect support for Ajax file upload in Webkit and Mozilla');
  }
  else {
    ok(!support, 'Detect lack of support for Ajax file upload in IE');
  }

  var support = PandaUploader.supportAjaxProgressEvents();
  var b = jQuery.browser;
  if (b.webkit || b.mozilla || b.msie && b.version >= 8) {
    ok(support, 'Detect support for Ajax progress events in Webkit, Mozilla and MSIE8+');
  }
  else {
    ok(!support, 'Detect lack of support for Ajax progress events in MSIE < 8');
  }

  var support = PandaUploader.supportHTML5Widget();
  var b = jQuery.browser;
  if (b.webkit || b.mozilla) {
    ok(support, 'Detect support for the HTML5 widget in Webkit and Mozilla');
  }
  else {
    ok(!support, 'Detect lack of support for the HTML5 widget in MSIE');
  }
});

test("Generate cross-site request object", function() {
  var xro = PandaUploader.createXRequestObject();
  var b = jQuery.browser;

  if (b.webkit || b.mozilla) {
    ok(xro instanceof XMLHttpRequest, 'XMLHttpRequest');
  }
  else if(b.msie && b.version >= 8) {
    ok(xro instanceof XDomainRequest, 'XDomainRequest');
  }
  else {
    equal(xro, null);
  }
});

test("Options validation", function () {
  PandaUploader.latest_alert = '';
  $('#the-file').checkPandaUploaderOptions(undefined, {});
  ok(PandaUploader.latest_alert.indexOf('error') != -1, 'Check that upload parameters are given');

  PandaUploader.latest_alert = '';
  $('#no-file').checkPandaUploaderOptions({}, {});
  ok(PandaUploader.latest_alert.indexOf('jQuery element is empty') != -1, 'Check that the jQuery object is not empty');

  PandaUploader.latest_alert = '';
  $('#file-2').checkPandaUploaderOptions({}, {});
  ok(PandaUploader.latest_alert.indexOf('Could not find a suitable form') != -1, 'Check that a suitable form exists');

  PandaUploader.latest_alert = '';
  $('#file-3').checkPandaUploaderOptions({}, {});
  ok(PandaUploader.latest_alert.indexOf('Neither NAME nor ID can') != -1, 'Check that there are no elements with a "submit" name/ID');

  PandaUploader.latest_alert = '';
  $('#file-1').checkPandaUploaderOptions({}, {upload_button_id: 'upload_button'});
  equal(PandaUploader.latest_alert, '', 'No errors show for a correct form')
});

if (PandaUploader.supportHTML5Widget()) {
  test("HTML5 widget load", function() {
    var query = $('#form-1 input[type=file]');
    equal(query.length, 1, "Check that a file upload field has been added");
  });
}

asyncTest("Flash widget load", function() {
  setTimeout(function(){
    var found = false;
    $('#form-6 object').each(function(){
      found = found || this.id.match(/^SWFUpload_\d$/)
    });
    ok(found, "Check that a file upload field has been added");

    var query = $('#form-6 input#file-6_orig-filename[type=text]')
    equal(query.length, 1, "Check that a field for the filename has been added");
    
    start();
  }, 100);
});

asyncTest("Upload on submit", function() {
  setTimeout(function(){
    ok($('#form-4 input[type=submit]').attr('disabled'), "Should disable submit button by default");
    ok( ! $('#form-5 input[type=submit]').attr('disabled'), "Should not disable submit button when told");
    start();
  }, 100);
});


});</script>

<h1 id="qunit-header"><code>panda_uploader</code> JS unit tests</h1>
<h2 id="qunit-banner"></h2>
<h2 id="qunit-userAgent"></h2>
<ol id="qunit-tests"></ol>

<h2>Test forms follow</h2>
<form id="form-1" class="good-form">
  <input type="hidden" id="file-1" />
</form>
<script type="text/javascript">
$('#file-1').pandaUploader(<%= @panda.signed_params("POST", "/videos.json").to_json %>);
</script>

<hr/>

<div id="form-2" class="bad-form">
  <input type="hidden" id="file-2" />
</div>

<hr/>

<form id="form-3" class="bad-form">
  <input type="hidden" id="file-3" />
  <input name="submit" type="submit" />
</form>

<hr/>

<form id="form-4" class="good-form">
  <input type="hidden" id="file-4" />
  <input type="submit" />
</form>
<script type="text/javascript">
$('#file-4').pandaUploader(<%= @panda.signed_params("POST", "/videos.json").to_json %>, {
  upload_strategy: new PandaUploader.UploadOnSubmit()
});
</script>

<hr/>

<form id="form-5" class="good-form">
  <input type="hidden" id="file-5" />
  <input type="submit" />
</form>
<script type="text/javascript">
$('#file-5').pandaUploader(<%= @panda.signed_params("POST", "/videos.json").to_json %>, {
  upload_strategy: new PandaUploader.UploadOnSubmit({ disable_submit_button: false })
});
</script>

<hr/>

<form id="form-6" class="good-form flash-forced">
  <input type="hidden" id="file-6" />
  <input type="submit" />
</form>
<script type="text/javascript">
$('#file-6').pandaUploader(<%= @panda.signed_params("POST", "/videos.json").to_json %>, {
  widget: new PandaUploader.FlashWidget()
});
</script>

